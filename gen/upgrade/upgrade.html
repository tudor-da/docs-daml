<!-- Copyright (c) 2021 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved. -->
<!-- SPDX-License-Identifier: Apache-2.0 -->



<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en">
<!--<![endif]-->

<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Upgrading Daml applications &mdash; Daml SDK __VERSION__ documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
  
  <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
  <script type="text/javascript" src="../_static/jquery.js"></script>
  <script type="text/javascript" src="../_static/underscore.js"></script>
  <script type="text/javascript" src="../_static/doctools.js"></script>
  <script type="text/javascript" src="../_static/language_data.js"></script>
  <script type="text/javascript" src="../_static/clipboard.min.js"></script>
  <script type="text/javascript" src="../_static/copybutton.js"></script>
  
  <script type="text/javascript" src="../_static/js/theme.js"></script>

  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
  <link rel="index" title="Index" href="../genindex.html" />
  <link rel="search" title="Search" href="../search.html" />
  <link rel="next" title="Automating the Upgrade Process" href="automation.html" />
  <link rel="prev" title="Extending Daml applications" href="extend.html" /> 

  
  <link rel="icon" type="image/svg+xml"  href="../_static/images/daml-logo-mark-light.svg">
  <link rel="alternate icon" href="../_static/images/daml-favicon-1.ico">

  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-MSWJMNX');</script>
  <!-- End Google Tag Manager -->

  
  <!-- Mopinion Pastea.se  start --><script type="text/javascript">(function(){var id="4s6vwov7ad6qyxhq8iwbyhocrsn2nm36k25";var js=document.createElement("script");js.setAttribute("type","text/javascript");js.setAttribute("src","//deploy.mopinion.com/js/pastease.js");js.async=true;document.getElementsByTagName("head")[0].appendChild(js);var t=setInterval(function(){try{new Pastease.load(id);clearInterval(t)}catch(e){}},50)})();</script><!-- Mopinion Pastea.se end -->
</head>

<body class="wy-body-for-nav">
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MSWJMNX"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->
   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-nav-side-shadow"></div>
      <div class="wy-side-scroll">

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
          
          
          
          
          
          <ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Daml Documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/installation.html">Installing the SDK</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/path-variables.html">Setting JAVA_HOME and PATH variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../getting-started/manual-download.html">Manually installing the SDK</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/index.html">Building Your App</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/app-architecture.html">App Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting-started/first-feature.html">Your First Feature</a></li>
<li class="toctree-l1"><a class="reference external" href="https://docs.daml.com/cheat-sheet">Cheat Sheet</a></li>
</ul>
<p class="caption"><span class="caption-text">Writing Daml</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../daml/intro/0_Intro.html">An introduction to Daml</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../daml/intro/1_Token.html">1 Basic contracts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/intro/2_DamlScript.html">2 Testing templates using Daml Script</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/intro/3_Data.html">3 Data types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/intro/4_Transformations.html">4 Transforming data using choices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/intro/5_Restrictions.html">5 Adding constraints to a contract</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/intro/6_Parties.html">6 Parties and authority</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/intro/7_Composing.html">7 Composing choices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/intro/8_Exceptions.html">8 Exception Handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/intro/9_Dependencies.html">9 Working with Dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/intro/10_Functional101.html">10 Functional Programming 101</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/intro/11_StdLib.html">11 Intro to the Daml Standard Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/intro/12_Testing.html">12 Testing Daml Contracts</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../daml/reference/index.html">Language reference docs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../daml/reference/structure.html">Overview: template structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/reference/templates.html">Templates</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/reference/choices.html">Choices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/reference/updates.html">Updates</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/reference/data-types.html">Data types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/reference/working-with.html">Built-in functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/reference/expressions.html">Expressions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/reference/functions.html">Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/reference/scenarios.html">Scenarios</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/reference/file-structure.html">File structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/reference/packages.html">Packages</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/reference/contract-keys.html">Contract keys</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/reference/exceptions.html">Exceptions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../daml/troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../daml/patterns.html">Good design patterns</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../daml/patterns/initaccept.html">Initiate and Accept</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/patterns/multiparty-agreement.html">Multiple party agreement</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/patterns/delegation.html">Delegation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/patterns/authorization.html">Authorization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../daml/patterns/locking.html">Locking</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../daml/patterns/locking/locking-by-archiving.html">Locking by archiving</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/patterns/locking/locking-by-state.html">Locking by state</a></li>
<li class="toctree-l3"><a class="reference internal" href="../daml/patterns/locking/locking-by-safekeeping.html">Locking by safekeeping</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../daml/patterns/legends.html">Diagram legends</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Building applications</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../app-dev/app-arch.html">Application architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../app-dev/bindings-ts/index.html">JavaScript Client Libraries</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../app-dev/bindings-ts/daml2js.html">JavaScript Code Generator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../app-dev/bindings-ts/daml-react.html">&#64;daml/react</a></li>
<li class="toctree-l2"><a class="reference internal" href="../app-dev/bindings-ts/daml-ledger.html">&#64;daml/ledger</a></li>
<li class="toctree-l2"><a class="reference internal" href="../app-dev/bindings-ts/daml-types.html">&#64;daml/types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../app-dev/bindings-ts/testing.html">Testing Your Web App</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../json-api/index.html">HTTP JSON API Service</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../json-api/lf-value-specification.html">Daml-LF JSON Encoding</a></li>
<li class="toctree-l2"><a class="reference internal" href="../json-api/search-query-language.html">Query language</a></li>
<li class="toctree-l2"><a class="reference internal" href="../json-api/production-setup.html">Production Setup</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../daml-script/index.html">Daml Script</a><ul class="simple">
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../daml-repl/index.html">Daml REPL</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Upgrading and Extending Daml applications</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="extend.html">Extending Daml applications</a><ul class="simple">
</ul>
</li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Upgrading Daml applications</a><ul class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="automation.html">Automating the Upgrade Process</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../app-dev/authorization.html">Authorization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../app-dev/ledger-api.html">The Ledger API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../app-dev/services.html">The Ledger API services</a></li>
<li class="toctree-l2"><a class="reference internal" href="../app-dev/grpc/index.html">gRPC</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../app-dev/grpc/error-codes.html">Error Codes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../app-dev/grpc/daml-to-ledger-api.html">How Daml types are translated to protobuf</a></li>
<li class="toctree-l2"><a class="reference internal" href="../app-dev/daml-lf-translation.html">How Daml types are translated to Daml-LF</a></li>
<li class="toctree-l2"><a class="reference internal" href="../app-dev/bindings-java/index.html">Java bindings</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../app-dev/bindings-java/codegen.html">Generate Java code from Daml</a></li>
<li class="toctree-l3"><a class="reference internal" href="../app-dev/bindings-java/example.html">Ping Pong Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="../app-dev/bindings-java/quickstart.html">Iou Quickstart Tutorial</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../app-dev/bindings-scala/index.html">Scala bindings</a></li>
<li class="toctree-l2"><a class="reference internal" href="../app-dev/bindings-js.html">Node.js bindings</a></li>
<li class="toctree-l2"><a class="reference internal" href="../app-dev/bindings-x-lang/index.html">Creating your own bindings</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../triggers/index.html">Daml Triggers - Off-Ledger Automation in Daml</a><ul class="simple">
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tools/trigger-service/index.html">Trigger Service</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../tools/trigger-service/authorization.html">Authorization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tools/trigger-service/auth0_example.html">Auth0 Example Configuration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tools/auth-middleware/index.html">Auth Middleware</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../tools/auth-middleware/oauth2.html">OAuth 2.0 Auth Middleware</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Deploying to Daml ledgers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../deploy/index.html">Overview of Daml ledgers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deploy/generic_ledger.html">Deploying to a generic Daml ledger</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deploy/ledger-topologies.html">Daml Ledger Topologies</a></li>
</ul>
<p class="caption"><span class="caption-text">Operating Daml</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../ops/index.html">Daml Participant pruning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ops/connect/index.html">Operating Daml Connect</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../ops/connect/helm.html">Connect Helm Chart</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ops/connect/auth0.html">Setting Up Auth0</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Developer Tools</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tools/assistant.html">Daml Assistant (<code class="docutils literal notranslate"><span class="pre">daml</span></code>)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../daml/daml-studio.html">Daml Studio</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/sandbox.html">Daml Sandbox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/navigator/index.html">Navigator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/codegen.html">Daml codegen</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/profiler.html">Daml Profiler</a></li>
</ul>
<p class="caption"><span class="caption-text">Background concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../concepts/glossary.html">Glossary of concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../concepts/ledger-model/index.html">Daml Ledger Model</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../concepts/ledger-model/ledger-structure.html">Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/ledger-model/ledger-integrity.html">Integrity</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/ledger-model/ledger-privacy.html">Privacy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/ledger-model/ledger-daml.html">Daml: Defining Contract Models Compactly</a></li>
<li class="toctree-l2"><a class="reference internal" href="../concepts/ledger-model/ledger-exceptions.html">Exceptions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../concepts/identity-and-package-management.html">Identity and Package Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../concepts/time.html">Time</a></li>
<li class="toctree-l1"><a class="reference internal" href="../concepts/local-ledger.html">Causality and Local Ledgers</a></li>
</ul>
<p class="caption"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://daml.com/examples">Examples</a></li>
</ul>
<p class="caption"><span class="caption-text">Early Access Features</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tools/extractor.html">Extractor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/export/index.html">Ledger Export</a></li>
<li class="toctree-l1"><a class="reference internal" href="../daml-integration-kit/index.html">Daml Integration Kit</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../tools/ledger-api-test-tool/index.html">Ledger API Test Tool</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tools/visual.html">Visualizing Daml Contracts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../concepts/interoperability.html">Ledger Interoperability</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/non-repudiation.html">Non-repudiation</a></li>
</ul>
<p class="caption"><span class="caption-text">Daml Ecosystem</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../support/overview.html">Daml Ecosystem Overview</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../support/status-definitions.html">Status Definitions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../support/component-statuses.html">Feature and Component Statuses</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../support/releases.html">Releases and Versioning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../support/compatibility.html">Portability, Compatibility, and Support Durations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../support/support.html">Getting Help</a></li>
</ul>

          
          
          
          <div class="pdf-download"><a href="../_downloads/DigitalAssetSDK.pdf" download>Download as PDF</a></div>
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <div class="topbar fixed">
        
        <nav class="wy-nav-top" aria-label="top navigation">
          
          <i data-toggle="wy-nav-top" class="wy-nav-top-toggle"></i>
          
        </nav>
        <!-- Copyright (c) 2021 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved. -->
<!-- SPDX-License-Identifier: Apache-2.0 -->

<div class="navbar">
    <h1><img src="../_static/images/DAML_Logo_Blue.svg"></h1>
    <div class="navbar-menu">
        <div class="da-menu-item da-menu-depth-1" role="menu">
            <a href="https://www.daml.com/" role="menuitem" class="da-menu-link">Developers</a>
        </div>
        <div class="da-menu-item da-menu-depth-1" role="menu">
            <a href="https://www.digitalasset.com/products" role="menuitem" class="da-menu-link">Products</a>
        </div>
        <div class="da-menu-item da-menu-depth-1" role="menu">
            <a href="https://www.digitalasset.com" role="menuitem" class="da-menu-link">Company</a>
        </div>
    </div>
</div>

        <div class="version ">
          <span class="hide-mobile">Version&nbsp;</span><span class="version_switcher_placeholder"></span>
          
        </div>


        <!-- Copyright (c) 2021 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved. -->
<!-- SPDX-License-Identifier: Apache-2.0 -->
<div class="search-inline">
    <div id="rtd-search-inline-form" class="wy-form">
        <input type="text" class="search-inline-input" placeholder="Search" name="q">
        <img src="../_static/images/Search.svg" class="search-inline-img"/>
    </div>
    <div class="search-alert">
        Please enter at least 3 letters.
    </div>
    <div id="search-inline-results" class="search-inline-results">
        
    </div>
</div>
          <!-- Copyright (c) 2021 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved. -->
<!-- SPDX-License-Identifier: Apache-2.0 -->

<div class="content-menu collapsed">
    <span class="content-menu-title">In This Section</span>
    <span class="content-menu-expand"></span>
    <div class="content-menu-wrapper">
        
        <!-- Local TOC -->
        <div class="content-menu-toc"><ul>
<li><a class="reference internal" href="#">Upgrading Daml applications</a><ul>
<li><a class="reference internal" href="#daml-upgrade-overview">Daml upgrade overview</a></li>
<li><a class="reference internal" href="#structuring-upgrade-contracts">Structuring upgrade contracts</a></li>
<li><a class="reference internal" href="#building-and-deploying-carbon-1-0-0">Building and deploying carbon-1.0.0</a></li>
<li><a class="reference internal" href="#create-some-carbon-1-0-0-certificates">Create some carbon-1.0.0 certificates</a></li>
<li><a class="reference internal" href="#building-and-deploying-carbon-2-0-0">Building and deploying carbon-2.0.0</a></li>
<li><a class="reference internal" href="#building-and-deploying-carbon-upgrade">Building and deploying carbon-upgrade</a></li>
<li><a class="reference internal" href="#upgrade-existing-certificates-from-carbon-1-0-0-to-carbon-2-0-0">Upgrade existing certificates from carbon-1.0.0 to carbon-2.0.0</a></li>
<li><a class="reference internal" href="#further-steps">Further Steps</a></li>
</ul>
</li>
</ul>
</div>
        
    </div>
</div>
        

      </div>
      <div class="wy-nav-content">
        
        <div class="rst-content">
          
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div itemprop="articleBody">
                
  <div class="section" id="upgrading-daml-applications">
<span id="upgrade-overview"></span><h1>Upgrading Daml applications<a class="headerlink" href="#upgrading-daml-applications" title="Permalink to this headline">¶</a></h1>
<div class="toctree-wrapper compound">
</div>
<p><strong>Note:</strong> Cross-SDK upgrades require Daml-LF 1.8 or newer.
This is the default starting from SDK 1.0. For older releases add
<code class="docutils literal notranslate"><span class="pre">build-options:</span> <span class="pre">[&quot;--target=1.8&quot;]</span></code> to your <code class="docutils literal notranslate"><span class="pre">daml.yaml</span></code> to select
Daml-LF 1.8.</p>
<p>In applications backed by a centralized database controlled by a
single operator, it is possible to upgrade an application in a single
step that migrates all existing data to a new data model.</p>
<p>As a running example, let’s imagine a centralized database containing
carbon offset certificates. Its operator created the database schema
with</p>
<div class="highlight-SQL notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">carbon_certs</span> <span class="p">(</span>
  <span class="n">carbon_metric_tons</span> <span class="n">VARINT</span><span class="p">,</span>
  <span class="k">owner</span> <span class="nb">VARCHAR</span> <span class="k">NOT</span> <span class="k">NULL</span>
  <span class="n">issuer</span> <span class="nb">VARCHAR</span> <span class="k">NOT</span> <span class="k">NULL</span>
<span class="p">)</span>
</pre></div>
</div>
<p>The certificate has a field for the quantity of offset carbon in
metric tons, an owner and an issuer.</p>
<p>In the next iteration of the application, the operator decides to also
store and display the carbon offset method. In the centralized case,
the operator can upgrade the database by executing the single SQL
command</p>
<div class="highlight-SQL notranslate"><div class="highlight"><pre><span></span><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">carbon_certs</span> <span class="k">ADD</span> <span class="n">carbon_offset_method</span> <span class="nb">VARCHAR</span> <span class="k">DEFAULT</span> <span class="ss">&quot;unknown&quot;</span>
</pre></div>
</div>
<p>This adds a new column to the <code class="docutils literal notranslate"><span class="pre">carbon_certs</span></code> table and inserts the
value <code class="docutils literal notranslate"><span class="pre">unknown</span></code> for all existing entries.</p>
<p>While upgrading this centralized database is simple and convenient,
its data entries lack any kind of signature and hence proof of
authenticity. The data consumers need to trust the operator.</p>
<p>In contrast, Daml templates always have at least one signatory. The
consequence is that the upgrade process for a Daml application needs
to be different.</p>
<div class="section" id="daml-upgrade-overview">
<h2>Daml upgrade overview<a class="headerlink" href="#daml-upgrade-overview" title="Permalink to this headline">¶</a></h2>
<p>In a Daml application running on a distributed ledger, the signatories
of a contract have agreed to one specific version of a template.
Changing the definition of a template, e.g., by extending it with a
new data field or choice without agreement from its signatories would
completely break the authorization guarantees provided by Daml.</p>
<p>Therefore, Daml takes a different approach to upgrades and
extensions. Rather than having a separate concept of data migration
that sidesteps the fundamental guarantees provided by Daml, <em>upgrades
are expressed as Daml contracts</em>. This means that the same guarantees
and rules that apply to other Daml contracts also apply to upgrades.</p>
<p>In a Daml application, it thus makes sense to think of upgrades as an
<em>extension of an existing application</em> instead of an operation that
replaces existing contracts with a newer version. The existing
templates stay on the ledger and can still be used. Contracts of
existing templates are not automatically replaced by newer versions.
However, the application is extended with new templates. Then if all
signatories of a contract agree, a choice can archive the old version
of a contract and create a new contract instead.</p>
</div>
<div class="section" id="structuring-upgrade-contracts">
<h2>Structuring upgrade contracts<a class="headerlink" href="#structuring-upgrade-contracts" title="Permalink to this headline">¶</a></h2>
<p>Upgrade contracts are specific to the templates that are being
upgraded. But most of them share common patterns. Here is the
implementation of the above <code class="docutils literal notranslate"><span class="pre">carbon_certs</span></code> schema in Daml. We have
some prescience that there will be future versions of <em>CarbonCert</em>,
and so place the definition of <code class="docutils literal notranslate"><span class="pre">CarbonCert</span></code> in a module named
<code class="docutils literal notranslate"><span class="pre">CarbonV1</span></code></p>
<div class="highlight-daml notranslate"><div class="highlight"><pre><span></span><span class="kr">module</span> <span class="nn">CarbonV1</span> <span class="kr">where</span>

<span class="kr">template</span> <span class="kt">CarbonCert</span>
  <span class="kr">with</span>
    <span class="n">issuer</span> <span class="kt">:</span> <span class="kt">Party</span>
    <span class="n">owner</span> <span class="kt">:</span> <span class="kt">Party</span>
    <span class="n">carbon_metric_tons</span> <span class="kt">:</span> <span class="kt">Int</span>
  <span class="kr">where</span>
    <span class="kr">signatory</span> <span class="n">issuer</span><span class="p">,</span> <span class="n">owner</span>
</pre></div>
</div>
<p>A <em>CarbonCert</em> has an issuer and an owner. Both are signatories. Our
goal is to extend this <em>CarbonCert</em> template with a field that adds
the method used to offset the carbon.  We use a different name for the
new template here for clarity. This is not required as templates are
identified by the triple <em>(PackageId, ModuleName, TemplateName)</em>.</p>
<div class="highlight-daml notranslate"><div class="highlight"><pre><span></span><span class="kr">module</span> <span class="nn">CarbonV2</span> <span class="kr">where</span>

<span class="kr">template</span> <span class="kt">CarbonCertWithMethod</span>
  <span class="kr">with</span>
    <span class="n">issuer</span> <span class="kt">:</span> <span class="kt">Party</span>
    <span class="n">owner</span> <span class="kt">:</span> <span class="kt">Party</span>
    <span class="n">carbon_metric_tons</span> <span class="kt">:</span> <span class="kt">Int</span>
    <span class="n">carbon_offset_method</span> <span class="kt">:</span> <span class="kt">Text</span>
  <span class="kr">where</span>
    <span class="kr">signatory</span> <span class="n">issuer</span><span class="p">,</span> <span class="n">owner</span>
</pre></div>
</div>
<p>Next, we need to provide a way for the signatories to agree to a
contract being upgraded. It would be possible to structure this such
that issuer and owner have to agree to an upgrade for each individual
<em>CarbonCert</em> contract separately. Since the template definition for
all of them is the same, this is usually not necessary for most
applications. Instead, we collect agreement from the signatories only
once and use that to upgrade all carbon certificates.</p>
<p>Since there are multiple signatories involved here, we use a
<a class="reference internal" href="../daml/intro/6_Parties.html#intro-propose-accept"><span class="std std-ref">Propose-Accept workflow</span></a>.  First, we
define an <em>UpgradeCarbonCertProposal</em> template that will be created by
the issuer. This template has an <em>Accept</em> choice that the <em>owner</em> can
exercise. Upon execution it will then create an
<em>UpgradeCarbonCertAgreement</em>.</p>
<div class="highlight-daml notranslate"><div class="highlight"><pre><span></span><span class="kr">template</span> <span class="kt">UpgradeCarbonCertProposal</span>
  <span class="kr">with</span>
    <span class="n">issuer</span> <span class="kt">:</span> <span class="kt">Party</span>
    <span class="n">owner</span> <span class="kt">:</span> <span class="kt">Party</span>
  <span class="kr">where</span>
    <span class="kr">signatory</span> <span class="n">issuer</span>
    <span class="kr">observer</span> <span class="n">owner</span>
    <span class="n">key</span> <span class="p">(</span><span class="n">issuer</span><span class="p">,</span> <span class="n">owner</span><span class="p">)</span> <span class="kt">:</span> <span class="p">(</span><span class="kt">Party</span><span class="p">,</span> <span class="kt">Party</span><span class="p">)</span>
    <span class="n">maintainer</span> <span class="n">key</span><span class="o">.</span><span class="n">_1</span>
    <span class="n">choice</span> <span class="kt">Accept</span> <span class="kt">:</span> <span class="kt">ContractId</span> <span class="kt">UpgradeCarbonCertAgreement</span>
      <span class="kr">controller</span> <span class="n">owner</span>
      <span class="kr">do</span> <span class="n">create</span> <span class="kt">UpgradeCarbonCertAgreement</span> <span class="kr">with</span> <span class="o">..</span>
</pre></div>
</div>
<p>Now we can define the <em>UpgradeCarbonCertAgreement</em> template. This
template has one <em>nonconsuming</em> choice that takes the contract ID of a
<em>CarbonCert</em> contract, archives this <em>CarbonCert</em> contract and creates a
<em>CarbonCertWithMethod</em> contract with the same issuer and owner and  the
<em>carbon_offset_method</em> set to <code class="docutils literal notranslate"><span class="pre">unknown</span></code>.</p>
<div class="highlight-daml notranslate"><div class="highlight"><pre><span></span><span class="kr">template</span> <span class="kt">UpgradeCarbonCertAgreement</span>
  <span class="kr">with</span>
    <span class="n">issuer</span> <span class="kt">:</span> <span class="kt">Party</span>
    <span class="n">owner</span> <span class="kt">:</span> <span class="kt">Party</span>
  <span class="kr">where</span>
    <span class="kr">signatory</span> <span class="n">issuer</span><span class="p">,</span> <span class="n">owner</span>
    <span class="n">key</span> <span class="p">(</span><span class="n">issuer</span><span class="p">,</span> <span class="n">owner</span><span class="p">)</span> <span class="kt">:</span> <span class="p">(</span><span class="kt">Party</span><span class="p">,</span> <span class="kt">Party</span><span class="p">)</span>
    <span class="n">maintainer</span> <span class="n">key</span><span class="o">.</span><span class="n">_1</span>
    <span class="kr">nonconsuming</span> <span class="n">choice</span> <span class="kt">Upgrade</span> <span class="kt">:</span> <span class="kt">ContractId</span> <span class="kt">CarbonCertWithMethod</span>
      <span class="kr">with</span>
        <span class="n">certId</span> <span class="kt">:</span> <span class="kt">ContractId</span> <span class="kt">CarbonCert</span>
      <span class="kr">controller</span> <span class="n">issuer</span>
      <span class="kr">do</span> <span class="n">cert</span> <span class="ow">&lt;-</span> <span class="n">fetch</span> <span class="n">certId</span>
         <span class="n">assert</span> <span class="p">(</span><span class="n">cert</span><span class="o">.</span><span class="n">issuer</span> <span class="o">==</span> <span class="n">issuer</span><span class="p">)</span>
         <span class="n">assert</span> <span class="p">(</span><span class="n">cert</span><span class="o">.</span><span class="n">owner</span> <span class="o">==</span> <span class="n">owner</span><span class="p">)</span>
         <span class="n">archive</span> <span class="n">certId</span>
         <span class="n">create</span> <span class="kt">CarbonCertWithMethod</span> <span class="kr">with</span>
           <span class="n">issuer</span> <span class="ow">=</span> <span class="n">cert</span><span class="o">.</span><span class="n">issuer</span>
           <span class="n">owner</span> <span class="ow">=</span> <span class="n">cert</span><span class="o">.</span><span class="n">owner</span>
           <span class="n">carbon_metric_tons</span> <span class="ow">=</span> <span class="n">cert</span><span class="o">.</span><span class="n">carbon_metric_tons</span>
           <span class="n">carbon_offset_method</span> <span class="ow">=</span> <span class="s">&quot;unknown&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="building-and-deploying-carbon-1-0-0">
<h2>Building and deploying carbon-1.0.0<a class="headerlink" href="#building-and-deploying-carbon-1-0-0" title="Permalink to this headline">¶</a></h2>
<p>Let’s see everything in action by first building and deploying
<code class="docutils literal notranslate"><span class="pre">carbon-1.0.0</span></code>. After this we’ll see how to deploy and upgrade to
<code class="docutils literal notranslate"><span class="pre">carbon-2.0.0</span></code> containing the <code class="docutils literal notranslate"><span class="pre">CarbonCertWithMethod</span></code> template.</p>
<p>First we’ll need a sandbox ledger to which we can deploy.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ daml sandbox --port 6865
</pre></div>
</div>
<p>Now we’ll setup the project for the original version of our
certificate. The project contains the Daml for just the <code class="docutils literal notranslate"><span class="pre">CarbonCert</span></code>
template, along with a <code class="docutils literal notranslate"><span class="pre">CarbonCertProposal</span></code> template which will
allow us to issue some coins in the example below.</p>
<p>Here is the project config.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">carbon</span>
<span class="nt">version</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1.0.0</span>
<span class="nt">dependencies</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">daml-prim</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">daml-stdlib</span>
</pre></div>
</div>
<p>Now we can build and deploy <code class="docutils literal notranslate"><span class="pre">carbon-1.0.0</span></code>.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ cd example/carbon-1.0.0
$ daml build
$ daml ledger upload-dar --port 6865
</pre></div>
</div>
</div>
<div class="section" id="create-some-carbon-1-0-0-certificates">
<h2>Create some carbon-1.0.0 certificates<a class="headerlink" href="#create-some-carbon-1-0-0-certificates" title="Permalink to this headline">¶</a></h2>
<p>Let’s create some certificates!</p>
<p>We’ll use the navigator to connect to the ledger, and create two
certificates issued by Alice, and owned by Bob.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ cd example/carbon-1.0.0
$ daml navigator server localhost 6865
</pre></div>
</div>
<p>We point a browser to <a class="reference external" href="http://localhost:4000">http://localhost:4000</a>, and follow the steps:</p>
<ol class="arabic simple">
<li><dl class="first docutils">
<dt>Login as Alice:</dt>
<dd><ol class="first last arabic">
<li>Select Templates tab.</li>
<li>Create a <em>CarbonCertProposal</em> with Alice as issuer and Bob as owner and an arbitrary value for the <code class="docutils literal notranslate"><span class="pre">carbon_metric_tons</span></code> field.</li>
<li>Create a 2nd proposal in the same way.</li>
</ol>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Login as Bob:</dt>
<dd><ol class="first last arabic">
<li>Exercise the <em>CarbonCertProposal_Accept</em> choice on both proposal contracts.</li>
</ol>
</dd>
</dl>
</li>
</ol>
</div>
<div class="section" id="building-and-deploying-carbon-2-0-0">
<h2>Building and deploying carbon-2.0.0<a class="headerlink" href="#building-and-deploying-carbon-2-0-0" title="Permalink to this headline">¶</a></h2>
<p>Now we setup the project for the improved certificates containing the <em>carbon_offset_method</em> field. This project contains only the <code class="docutils literal notranslate"><span class="pre">CarbonCertWithMethod</span></code> template. The upgrade templates are in a third <code class="docutils literal notranslate"><span class="pre">carbon-upgrade</span></code> package. While it would be possible to include the upgrade templates in the same package, this means that the package containing the new <code class="docutils literal notranslate"><span class="pre">CarbonCertWithMethod</span></code> template depends on the previous version. With the approach taken here of keeping the upgrade templates in a separate package, the <code class="docutils literal notranslate"><span class="pre">carbon-1.0.0</span></code> package is no longer needed once we have upgraded all certificates.</p>
<p>It’s worth stressing here that extensions always need to go into separate packages. We cannot just add the new definitions to the original project, rebuild and re-deploy. This is because the cryptographically computed package identifier would change. Consequently, it would not match the package identifier of the original <code class="docutils literal notranslate"><span class="pre">CarbonCert</span></code> contracts from <code class="docutils literal notranslate"><span class="pre">carbon-1.0.0</span></code> which are live on the ledger.</p>
<p>Here is the new project config:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">carbon</span>
<span class="nt">version</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">2.0.0</span>
<span class="nt">dependencies</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">daml-prim</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">daml-stdlib</span>
</pre></div>
</div>
<p>Now we can build and deploy <code class="docutils literal notranslate"><span class="pre">carbon-2.0.0</span></code>.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ cd example/carbon-2.0.0
$ daml build
$ daml ledger upload-dar --port 6865
</pre></div>
</div>
</div>
<div class="section" id="building-and-deploying-carbon-upgrade">
<h2>Building and deploying carbon-upgrade<a class="headerlink" href="#building-and-deploying-carbon-upgrade" title="Permalink to this headline">¶</a></h2>
<p>Having built and deployed <code class="docutils literal notranslate"><span class="pre">carbon-1.0.0</span></code> and <code class="docutils literal notranslate"><span class="pre">carbon-2.0.0</span></code> we are
now ready to build the upgrade package <code class="docutils literal notranslate"><span class="pre">carbon-upgrade</span></code>. The project
config references both <code class="docutils literal notranslate"><span class="pre">carbon-1.0.0</span></code> and <code class="docutils literal notranslate"><span class="pre">carbon-2.0.0</span></code> via the
<code class="docutils literal notranslate"><span class="pre">data-dependencies</span></code> field. This allows us to import modules from the
respective packages. With these imported modules we can reference
templates from packages that we already uploaded to the ledger.</p>
<p>When following this example, <code class="docutils literal notranslate"><span class="pre">path/to/carbon-1.0.0.dar</span></code> and
<code class="docutils literal notranslate"><span class="pre">path/to/carbon-2.0.0.dar</span></code> should be replaced by the relative or
absolute path to the DAR file created by building the respective
projects. Commonly the <code class="docutils literal notranslate"><span class="pre">carbon-1.0.0</span></code> and <code class="docutils literal notranslate"><span class="pre">carbon-2.0.0</span></code> projects
would be sibling directories in the file systems, so this path would
be: <code class="docutils literal notranslate"><span class="pre">../carbon-1.0.0/.daml/dist/carbon-1.0.0.dar</span></code>.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">carbon-upgrade</span>
<span class="nt">version</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1.0.0</span>
<span class="nt">dependencies</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">daml-prim</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">daml-stdlib</span>
<span class="nt">data-dependencies</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">path/to/carbon-1.0.0.dar</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">path/to/carbon-2.0.0.dar</span>
</pre></div>
</div>
<p>The Daml for the upgrade contracts imports the modules for both the new
and old certificate versions.</p>
<div class="highlight-daml notranslate"><div class="highlight"><pre><span></span><span class="kr">module</span> <span class="nn">UpgradeFromCarbonCertV1</span> <span class="kr">where</span>
<span class="kr">import</span> <span class="nn">CarbonV1</span>
<span class="kr">import</span> <span class="nn">CarbonV2</span>
</pre></div>
</div>
<p>Now we can build and deploy <code class="docutils literal notranslate"><span class="pre">carbon-upgrade</span></code>. Note that uploading a
DAR also uploads its dependencies so if <code class="docutils literal notranslate"><span class="pre">carbon-1.0.0</span></code> and
<code class="docutils literal notranslate"><span class="pre">carbon-2.0.0</span></code> had not already been deployed before, they would be
deployed as part of deploying <code class="docutils literal notranslate"><span class="pre">carbon-upgrade</span></code>.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ cd example/carbon-upgrade
$ daml build
$ daml ledger upload-dar --port 6865
</pre></div>
</div>
</div>
<div class="section" id="upgrade-existing-certificates-from-carbon-1-0-0-to-carbon-2-0-0">
<h2>Upgrade existing certificates from carbon-1.0.0 to carbon-2.0.0<a class="headerlink" href="#upgrade-existing-certificates-from-carbon-1-0-0-to-carbon-2-0-0" title="Permalink to this headline">¶</a></h2>
<p>We start the navigator again.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ cd example/carbon-upgrade
$ daml navigator server localhost 6865
</pre></div>
</div>
<p>Finally, we point a browser to <a class="reference external" href="http://localhost:4000">http://localhost:4000</a> and can start the carbon certificates upgrades:</p>
<ol class="arabic simple">
<li><dl class="first docutils">
<dt>Login as Alice</dt>
<dd><ol class="first last arabic">
<li>Select Templates tab.</li>
<li>Create an <code class="docutils literal notranslate"><span class="pre">UpgradeCarbonCertProposal</span></code> with Alice as issuer and Bob as owner.</li>
</ol>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Login as Bob</dt>
<dd><ol class="first last arabic">
<li>Exercise the <code class="docutils literal notranslate"><span class="pre">Accept</span></code> choice of the upgrade proposal, creating an <code class="docutils literal notranslate"><span class="pre">UpgradeCarbonCertAgreement</span></code>.</li>
</ol>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Login again as Alice</dt>
<dd><ol class="first last arabic">
<li>Use the <code class="docutils literal notranslate"><span class="pre">UpgradeCarbonCertAgreement</span></code> repeatedly to upgrade any certificate for which Alice is issuer and Bob is owner.</li>
</ol>
</dd>
</dl>
</li>
</ol>
</div>
<div class="section" id="further-steps">
<h2>Further Steps<a class="headerlink" href="#further-steps" title="Permalink to this headline">¶</a></h2>
<p>For the upgrade of our carbon certificate model above, we performed all steps
manually via Navigator. However, if Alice had issued millions of
carbon certificates, performing all upgrading steps manually becomes infeasible.  It
thus becomes necessary to automate these steps. We will go through a
potential implementation of an automated upgrade in the <a class="reference internal" href="automation.html#upgrade-automation"><span class="std std-ref">next section</span></a>.</p>
</div>
</div>


              
            </div>
            
            
              <!-- Copyright (c) 2021 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved. -->
<!-- SPDX-License-Identifier: Apache-2.0 -->

<footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="extend.html" class="da-btn da-btn-label btn-prev" title="Extending Daml applications" accesskey="p" rel="prev">Previous</a>
      
      
        <a href="automation.html" class="da-btn da-btn-label btn-next" title="Automating the Upgrade Process" accesskey="n" rel="next">Next</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        Copyright (c) 2021 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved. Any unauthorized use, duplication or distribution is strictly prohibited. &#34;Digital Asset&#34; and &#34;Daml&#34; are Registered in the U.S. Patent and Trademark Office.

    </p>
  </div> 

</footer>
            
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Copyright (c) 2021 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved. -->
<!-- SPDX-License-Identifier: Apache-2.0 -->





  <script type="text/javascript">
    jQuery(function () {
      SphinxRtdTheme.Navigation.enable(true);
      });
  </script>


  
    
  
  <div id="inpageContent"></div>
  

</body>
</html>