<!-- Copyright (c) 2021 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved. -->
<!-- SPDX-License-Identifier: Apache-2.0 -->



<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en">
<!--<![endif]-->

<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>5 Adding constraints to a contract &mdash; Daml SDK __VERSION__ documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
  
  <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
  <script type="text/javascript" src="../../_static/jquery.js"></script>
  <script type="text/javascript" src="../../_static/underscore.js"></script>
  <script type="text/javascript" src="../../_static/doctools.js"></script>
  <script type="text/javascript" src="../../_static/language_data.js"></script>
  <script type="text/javascript" src="../../_static/clipboard.min.js"></script>
  <script type="text/javascript" src="../../_static/copybutton.js"></script>
  
  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
  <link rel="index" title="Index" href="../../genindex.html" />
  <link rel="search" title="Search" href="../../search.html" />
  <link rel="next" title="6 Parties and authority" href="6_Parties.html" />
  <link rel="prev" title="4 Transforming data using choices" href="4_Transformations.html" /> 

  
  <link rel="icon" type="image/svg+xml"  href="../../_static/images/daml-logo-mark-light.svg">
  <link rel="alternate icon" href="../../_static/images/daml-favicon-1.ico">

  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-MSWJMNX');</script>
  <!-- End Google Tag Manager -->

  
  <!-- Mopinion Pastea.se  start --><script type="text/javascript">(function(){var id="4s6vwov7ad6qyxhq8iwbyhocrsn2nm36k25";var js=document.createElement("script");js.setAttribute("type","text/javascript");js.setAttribute("src","//deploy.mopinion.com/js/pastease.js");js.async=true;document.getElementsByTagName("head")[0].appendChild(js);var t=setInterval(function(){try{new Pastease.load(id);clearInterval(t)}catch(e){}},50)})();</script><!-- Mopinion Pastea.se end -->
</head>

<body class="wy-body-for-nav">
  <!-- Google Tag Manager (noscript) -->
  <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MSWJMNX"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
  <!-- End Google Tag Manager (noscript) -->
   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-nav-side-shadow"></div>
      <div class="wy-side-scroll">

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
          
          
          
          
          
          <ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">Daml Documentation</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/installation.html">Installing the SDK</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../getting-started/path-variables.html">Setting JAVA_HOME and PATH variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../getting-started/manual-download.html">Manually installing the SDK</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/index.html">Building Your App</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/app-architecture.html">App Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started/first-feature.html">Your First Feature</a></li>
<li class="toctree-l1"><a class="reference external" href="https://docs.daml.com/cheat-sheet">Cheat Sheet</a></li>
</ul>
<p class="caption"><span class="caption-text">Writing Daml</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="0_Intro.html">An introduction to Daml</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="1_Token.html">1 Basic contracts</a></li>
<li class="toctree-l2"><a class="reference internal" href="2_DamlScript.html">2 Testing templates using Daml Script</a></li>
<li class="toctree-l2"><a class="reference internal" href="3_Data.html">3 Data types</a></li>
<li class="toctree-l2"><a class="reference internal" href="4_Transformations.html">4 Transforming data using choices</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">5 Adding constraints to a contract</a></li>
<li class="toctree-l2"><a class="reference internal" href="6_Parties.html">6 Parties and authority</a></li>
<li class="toctree-l2"><a class="reference internal" href="7_Composing.html">7 Composing choices</a></li>
<li class="toctree-l2"><a class="reference internal" href="8_Exceptions.html">8 Exception Handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="9_Dependencies.html">9 Working with Dependencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="10_Functional101.html">10 Functional Programming 101</a></li>
<li class="toctree-l2"><a class="reference internal" href="11_StdLib.html">11 Intro to the Daml Standard Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="12_Testing.html">12 Testing Daml Contracts</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">Language reference docs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../reference/structure.html">Overview: template structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/templates.html">Templates</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/choices.html">Choices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/updates.html">Updates</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/data-types.html">Data types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/working-with.html">Built-in functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/expressions.html">Expressions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/functions.html">Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/scenarios.html">Scenarios</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/file-structure.html">File structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/packages.html">Packages</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/contract-keys.html">Contract keys</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reference/exceptions.html">Exceptions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../patterns.html">Good design patterns</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../patterns/initaccept.html">Initiate and Accept</a></li>
<li class="toctree-l2"><a class="reference internal" href="../patterns/multiparty-agreement.html">Multiple party agreement</a></li>
<li class="toctree-l2"><a class="reference internal" href="../patterns/delegation.html">Delegation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../patterns/authorization.html">Authorization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../patterns/locking.html">Locking</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../patterns/locking/locking-by-archiving.html">Locking by archiving</a></li>
<li class="toctree-l3"><a class="reference internal" href="../patterns/locking/locking-by-state.html">Locking by state</a></li>
<li class="toctree-l3"><a class="reference internal" href="../patterns/locking/locking-by-safekeeping.html">Locking by safekeeping</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../patterns/legends.html">Diagram legends</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Building applications</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../app-dev/app-arch.html">Application architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../app-dev/bindings-ts/index.html">JavaScript Client Libraries</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../app-dev/bindings-ts/daml2js.html">JavaScript Code Generator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../app-dev/bindings-ts/daml-react.html">&#64;daml/react</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../app-dev/bindings-ts/daml-ledger.html">&#64;daml/ledger</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../app-dev/bindings-ts/daml-types.html">&#64;daml/types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../app-dev/bindings-ts/testing.html">Testing Your Web App</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../json-api/index.html">HTTP JSON API Service</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../json-api/lf-value-specification.html">Daml-LF JSON Encoding</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../json-api/search-query-language.html">Query language</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../json-api/production-setup.html">Production Setup</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../daml-script/index.html">Daml Script</a><ul class="simple">
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../daml-repl/index.html">Daml REPL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../upgrade/index.html">Upgrading and Extending Daml applications</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../upgrade/extend.html">Extending Daml applications</a><ul class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../upgrade/upgrade.html">Upgrading Daml applications</a><ul class="simple">
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../upgrade/automation.html">Automating the Upgrade Process</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../app-dev/authorization.html">Authorization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../app-dev/ledger-api.html">The Ledger API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../app-dev/services.html">The Ledger API services</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../app-dev/grpc/index.html">gRPC</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../app-dev/grpc/error-codes.html">Error Codes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../app-dev/grpc/daml-to-ledger-api.html">How Daml types are translated to protobuf</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../app-dev/daml-lf-translation.html">How Daml types are translated to Daml-LF</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../app-dev/bindings-java/index.html">Java bindings</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../app-dev/bindings-java/codegen.html">Generate Java code from Daml</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../app-dev/bindings-java/example.html">Ping Pong Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../app-dev/bindings-java/quickstart.html">Iou Quickstart Tutorial</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../app-dev/bindings-scala/index.html">Scala bindings</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../app-dev/bindings-js.html">Node.js bindings</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../app-dev/bindings-x-lang/index.html">Creating your own bindings</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../triggers/index.html">Daml Triggers - Off-Ledger Automation in Daml</a><ul class="simple">
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/trigger-service/index.html">Trigger Service</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../tools/trigger-service/authorization.html">Authorization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tools/trigger-service/auth0_example.html">Auth0 Example Configuration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/auth-middleware/index.html">Auth Middleware</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../tools/auth-middleware/oauth2.html">OAuth 2.0 Auth Middleware</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Deploying to Daml ledgers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../deploy/index.html">Overview of Daml ledgers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deploy/generic_ledger.html">Deploying to a generic Daml ledger</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deploy/ledger-topologies.html">Daml Ledger Topologies</a></li>
</ul>
<p class="caption"><span class="caption-text">Operating Daml</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../ops/index.html">Daml Participant pruning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ops/connect/index.html">Operating Daml Connect</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../ops/connect/helm.html">Connect Helm Chart</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ops/connect/auth0.html">Setting Up Auth0</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Developer Tools</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tools/assistant.html">Daml Assistant (<code class="docutils literal notranslate"><span class="pre">daml</span></code>)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../daml-studio.html">Daml Studio</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/sandbox.html">Daml Sandbox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/navigator/index.html">Navigator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/codegen.html">Daml codegen</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/profiler.html">Daml Profiler</a></li>
</ul>
<p class="caption"><span class="caption-text">Background concepts</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../concepts/glossary.html">Glossary of concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../concepts/ledger-model/index.html">Daml Ledger Model</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../concepts/ledger-model/ledger-structure.html">Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../concepts/ledger-model/ledger-integrity.html">Integrity</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../concepts/ledger-model/ledger-privacy.html">Privacy</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../concepts/ledger-model/ledger-daml.html">Daml: Defining Contract Models Compactly</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../concepts/ledger-model/ledger-exceptions.html">Exceptions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../concepts/identity-and-package-management.html">Identity and Package Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../concepts/time.html">Time</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../concepts/local-ledger.html">Causality and Local Ledgers</a></li>
</ul>
<p class="caption"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://daml.com/examples">Examples</a></li>
</ul>
<p class="caption"><span class="caption-text">Early Access Features</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tools/extractor.html">Extractor</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/export/index.html">Ledger Export</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../daml-integration-kit/index.html">Daml Integration Kit</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../tools/ledger-api-test-tool/index.html">Ledger API Test Tool</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/visual.html">Visualizing Daml Contracts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../concepts/interoperability.html">Ledger Interoperability</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/non-repudiation.html">Non-repudiation</a></li>
</ul>
<p class="caption"><span class="caption-text">Daml Ecosystem</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../support/overview.html">Daml Ecosystem Overview</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../support/status-definitions.html">Status Definitions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../support/component-statuses.html">Feature and Component Statuses</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../support/releases.html">Releases and Versioning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../support/compatibility.html">Portability, Compatibility, and Support Durations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../support/support.html">Getting Help</a></li>
</ul>

          
          
          
          <div class="pdf-download"><a href="../../_downloads/DigitalAssetSDK.pdf" download>Download as PDF</a></div>
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <div class="topbar fixed">
        
        <nav class="wy-nav-top" aria-label="top navigation">
          
          <i data-toggle="wy-nav-top" class="wy-nav-top-toggle"></i>
          
        </nav>
        <!-- Copyright (c) 2021 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved. -->
<!-- SPDX-License-Identifier: Apache-2.0 -->

<div class="navbar">
    <h1><img src="../../_static/images/DAML_Logo_Blue.svg"></h1>
    <div class="navbar-menu">
        <div class="da-menu-item da-menu-depth-1" role="menu">
            <a href="https://www.daml.com/" role="menuitem" class="da-menu-link">Developers</a>
        </div>
        <div class="da-menu-item da-menu-depth-1" role="menu">
            <a href="https://www.digitalasset.com/products" role="menuitem" class="da-menu-link">Products</a>
        </div>
        <div class="da-menu-item da-menu-depth-1" role="menu">
            <a href="https://www.digitalasset.com" role="menuitem" class="da-menu-link">Company</a>
        </div>
    </div>
</div>

        <div class="version ">
          <span class="hide-mobile">Version&nbsp;</span><span class="version_switcher_placeholder"></span>
          
        </div>


        <!-- Copyright (c) 2021 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved. -->
<!-- SPDX-License-Identifier: Apache-2.0 -->
<div class="search-inline">
    <div id="rtd-search-inline-form" class="wy-form">
        <input type="text" class="search-inline-input" placeholder="Search" name="q">
        <img src="../../_static/images/Search.svg" class="search-inline-img"/>
    </div>
    <div class="search-alert">
        Please enter at least 3 letters.
    </div>
    <div id="search-inline-results" class="search-inline-results">
        
    </div>
</div>
          <!-- Copyright (c) 2021 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved. -->
<!-- SPDX-License-Identifier: Apache-2.0 -->

<div class="content-menu collapsed">
    <span class="content-menu-title">In This Section</span>
    <span class="content-menu-expand"></span>
    <div class="content-menu-wrapper">
        
        <!-- Local TOC -->
        <div class="content-menu-toc"><ul>
<li><a class="reference internal" href="#">5 Adding constraints to a contract</a><ul>
<li><a class="reference internal" href="#template-preconditions">Template preconditions</a></li>
<li><a class="reference internal" href="#assertions">Assertions</a></li>
<li><a class="reference internal" href="#time-on-daml-ledgers">Time on Daml ledgers</a><ul>
<li><a class="reference internal" href="#time-in-test-scripts">Time in test scripts</a></li>
<li><a class="reference internal" href="#time-on-ledgers">Time on ledgers</a></li>
</ul>
</li>
<li><a class="reference internal" href="#actions-and-do-blocks">Actions and <code class="docutils literal notranslate"><span class="pre">do</span></code> blocks</a><ul>
<li><a class="reference internal" href="#pure-expressions-compared-to-actions">Pure expressions compared to Actions</a></li>
<li><a class="reference internal" href="#actions-and-impurity">Actions and impurity</a></li>
<li><a class="reference internal" href="#chaining-up-actions-with-do-blocks">Chaining up actions with do blocks</a></li>
<li><a class="reference internal" href="#wrapping-values-in-actions">Wrapping values in actions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#failing-actions">Failing actions</a></li>
<li><a class="reference internal" href="#a-sample-action">A sample Action</a></li>
<li><a class="reference internal" href="#errors">Errors</a></li>
<li><a class="reference internal" href="#next-up">Next up</a></li>
</ul>
</li>
</ul>
</div>
        
    </div>
</div>
        

      </div>
      <div class="wy-nav-content">
        
        <div class="rst-content">
          
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div itemprop="articleBody">
                
  <div class="section" id="adding-constraints-to-a-contract">
<h1>5 Adding constraints to a contract<a class="headerlink" href="#adding-constraints-to-a-contract" title="Permalink to this headline">¶</a></h1>
<p>You will often want to constrain the data stored or the allowed data transformations in your contract models. In this section, you will learn about the two main mechanisms provided in Daml:</p>
<ul class="simple">
<li>The <code class="docutils literal notranslate"><span class="pre">ensure</span></code> keyword.</li>
<li>The <code class="docutils literal notranslate"><span class="pre">assert</span></code>, <code class="docutils literal notranslate"><span class="pre">abort</span></code> and <code class="docutils literal notranslate"><span class="pre">error</span></code> keywords.</li>
</ul>
<p>To make sense of the latter, you’ll also learn more about the <code class="docutils literal notranslate"><span class="pre">Update</span></code> and <code class="docutils literal notranslate"><span class="pre">Script</span></code> types and <code class="docutils literal notranslate"><span class="pre">do</span></code> blocks, which will be good preparation for <a class="reference internal" href="7_Composing.html"><span class="doc">7 Composing choices</span></a>, where you will use <code class="docutils literal notranslate"><span class="pre">do</span></code> blocks to compose choices into complex transactions.</p>
<p>Lastly, you will learn about time on the ledger and in Daml Script.</p>
<div class="admonition hint">
<p class="first admonition-title">Hint</p>
<p class="last">Remember that you can load all the code for this section into a folder called <code class="docutils literal notranslate"><span class="pre">5_Restrictions</span></code> by running <code class="docutils literal notranslate"><span class="pre">daml</span> <span class="pre">new</span> <span class="pre">5_Restrictions</span> <span class="pre">--template</span> <span class="pre">daml-intro-5</span></code></p>
</div>
<div class="section" id="template-preconditions">
<h2>Template preconditions<a class="headerlink" href="#template-preconditions" title="Permalink to this headline">¶</a></h2>
<p>The first kind of restriction you may want to put on the contract model are called <em>template pre-conditions</em>. These are simply restrictions on the data that can be stored on a contract from that template.</p>
<p>Suppose, for example, that the <code class="docutils literal notranslate"><span class="pre">SimpleIou</span></code> contract from <a class="reference internal" href="4_Transformations.html#simple-iou"><span class="std std-ref">A simple cash model</span></a> should only be able to store positive amounts. You can enforce this using the <code class="docutils literal notranslate"><span class="pre">ensure</span></code> keyword:</p>
<div class="highlight-daml notranslate"><div class="highlight"><pre><span></span><span class="kr">template</span> <span class="kt">SimpleIou</span>
  <span class="kr">with</span>
    <span class="n">issuer</span> <span class="kt">:</span> <span class="kt">Party</span>
    <span class="n">owner</span> <span class="kt">:</span> <span class="kt">Party</span>
    <span class="n">cash</span> <span class="kt">:</span> <span class="kt">Cash</span>
  <span class="kr">where</span>
    <span class="kr">signatory</span> <span class="n">issuer</span>

    <span class="kr">ensure</span> <span class="n">cash</span><span class="o">.</span><span class="n">amount</span> <span class="o">&gt;</span> <span class="mf">0.0</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">ensure</span></code> keyword takes a single expression of type <code class="docutils literal notranslate"><span class="pre">Bool</span></code>. If you want to add more restrictions, use logical operators <code class="docutils literal notranslate"><span class="pre">&amp;&amp;</span></code>, <code class="docutils literal notranslate"><span class="pre">||</span></code> and <code class="docutils literal notranslate"><span class="pre">not</span></code> to build up expressions. The below shows the additional restriction that currencies are three capital letters:</p>
<div class="highlight-daml notranslate"><div class="highlight"><pre><span></span>        <span class="o">&amp;&amp;</span> <span class="kt">T</span><span class="o">.</span><span class="n">length</span> <span class="n">cash</span><span class="o">.</span><span class="n">currency</span> <span class="o">==</span> <span class="mi">3</span>
        <span class="o">&amp;&amp;</span> <span class="kt">T</span><span class="o">.</span><span class="n">isUpper</span> <span class="n">cash</span><span class="o">.</span><span class="n">currency</span>
</pre></div>
</div>
<div class="admonition hint">
<p class="first admonition-title">Hint</p>
<p class="last">The <code class="docutils literal notranslate"><span class="pre">T</span></code> here stands for the <code class="docutils literal notranslate"><span class="pre">DA.Text</span></code> standard library which has been imported using <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">DA.Text</span> <span class="pre">as</span> <span class="pre">T</span></code>.</p>
</div>
<div class="highlight-daml notranslate"><div class="highlight"><pre><span></span><span class="nf">test_restrictions</span> <span class="ow">=</span> <span class="kr">do</span>
  <span class="n">alice</span> <span class="ow">&lt;-</span> <span class="n">allocateParty</span> <span class="s">&quot;Alice&quot;</span>
  <span class="n">bob</span> <span class="ow">&lt;-</span> <span class="n">allocateParty</span> <span class="s">&quot;Bob&quot;</span>
  <span class="n">dora</span> <span class="ow">&lt;-</span> <span class="n">allocateParty</span> <span class="s">&quot;Dora&quot;</span>

  <span class="c1">-- Dora can&#39;t issue negative Ious.</span>
  <span class="n">submitMustFail</span> <span class="n">dora</span> <span class="kr">do</span>
    <span class="n">createCmd</span> <span class="kt">SimpleIou</span> <span class="kr">with</span>
      <span class="n">issuer</span> <span class="ow">=</span> <span class="n">dora</span>
      <span class="n">owner</span> <span class="ow">=</span> <span class="n">alice</span>
      <span class="n">cash</span> <span class="ow">=</span> <span class="kt">Cash</span> <span class="kr">with</span>
        <span class="n">amount</span> <span class="ow">=</span> <span class="o">-</span><span class="mf">100.0</span>
        <span class="n">currency</span> <span class="ow">=</span> <span class="s">&quot;USD&quot;</span>

  <span class="c1">-- Or even zero Ious.</span>
  <span class="n">submitMustFail</span> <span class="n">dora</span> <span class="kr">do</span>
    <span class="n">createCmd</span> <span class="kt">SimpleIou</span> <span class="kr">with</span>
      <span class="n">issuer</span> <span class="ow">=</span> <span class="n">dora</span>
      <span class="n">owner</span> <span class="ow">=</span> <span class="n">alice</span>
      <span class="n">cash</span> <span class="ow">=</span> <span class="kt">Cash</span> <span class="kr">with</span>
        <span class="n">amount</span> <span class="ow">=</span> <span class="mf">0.0</span>
        <span class="n">currency</span> <span class="ow">=</span> <span class="s">&quot;USD&quot;</span>

  <span class="c1">-- Nor positive Ious with invalid currencies.</span>
  <span class="n">submitMustFail</span> <span class="n">dora</span> <span class="kr">do</span>
    <span class="n">createCmd</span> <span class="kt">SimpleIou</span> <span class="kr">with</span>
      <span class="n">issuer</span> <span class="ow">=</span> <span class="n">dora</span>
      <span class="n">owner</span> <span class="ow">=</span> <span class="n">alice</span>
      <span class="n">cash</span> <span class="ow">=</span> <span class="kt">Cash</span> <span class="kr">with</span>
        <span class="n">amount</span> <span class="ow">=</span> <span class="mf">100.0</span>
        <span class="n">currency</span> <span class="ow">=</span> <span class="s">&quot;Swiss Francs&quot;</span>

  <span class="c1">-- But positive Ious still work, of course.</span>
  <span class="n">iou</span> <span class="ow">&lt;-</span> <span class="n">submit</span> <span class="n">dora</span> <span class="kr">do</span>
    <span class="n">createCmd</span> <span class="kt">SimpleIou</span> <span class="kr">with</span>
      <span class="n">issuer</span> <span class="ow">=</span> <span class="n">dora</span>
      <span class="n">owner</span> <span class="ow">=</span> <span class="n">alice</span>
      <span class="n">cash</span> <span class="ow">=</span> <span class="kt">Cash</span> <span class="kr">with</span>
        <span class="n">amount</span> <span class="ow">=</span> <span class="mf">100.0</span>
        <span class="n">currency</span> <span class="ow">=</span> <span class="s">&quot;USD&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="assertions">
<h2>Assertions<a class="headerlink" href="#assertions" title="Permalink to this headline">¶</a></h2>
<p>A second common kind of restriction is one on data transformations.</p>
<p>For example, the simple Iou in <a class="reference internal" href="4_Transformations.html#simple-iou"><span class="std std-ref">A simple cash model</span></a> allowed the no-op where the <code class="docutils literal notranslate"><span class="pre">owner</span></code> transfers to themselves. You can prevent that using an <code class="docutils literal notranslate"><span class="pre">assert</span></code> statement, which you have already encountered in the context of scripts.</p>
<p><code class="docutils literal notranslate"><span class="pre">assert</span></code> does not return an informative error so often it’s better to use the function <code class="docutils literal notranslate"><span class="pre">assertMsg</span></code>, which takes a custom error message:</p>
<div class="highlight-daml notranslate"><div class="highlight"><pre><span></span>    <span class="kr">controller</span> <span class="n">owner</span> <span class="kr">can</span>
      <span class="kt">Transfer</span>
        <span class="kt">:</span> <span class="kt">ContractId</span> <span class="kt">SimpleIou</span>
        <span class="kr">with</span>
          <span class="n">newOwner</span> <span class="kt">:</span> <span class="kt">Party</span>
        <span class="kr">do</span>
          <span class="n">assertMsg</span> <span class="s">&quot;newOwner cannot be equal to owner.&quot;</span> <span class="p">(</span><span class="n">owner</span> <span class="o">/=</span> <span class="n">newOwner</span><span class="p">)</span>
          <span class="n">create</span> <span class="kr">this</span> <span class="kr">with</span> <span class="n">owner</span> <span class="ow">=</span> <span class="n">newOwner</span>
</pre></div>
</div>
<div class="highlight-daml notranslate"><div class="highlight"><pre><span></span>  <span class="c1">-- Alice can&#39;t transfer to herself...</span>
  <span class="n">submitMustFail</span> <span class="n">alice</span> <span class="kr">do</span>
    <span class="n">exerciseCmd</span> <span class="n">iou</span> <span class="kt">Transfer</span> <span class="kr">with</span>
      <span class="n">newOwner</span> <span class="ow">=</span> <span class="n">alice</span>

  <span class="c1">-- ... but can transfer to Bob.</span>
  <span class="n">iou2</span> <span class="ow">&lt;-</span> <span class="n">submit</span> <span class="n">alice</span> <span class="kr">do</span>
    <span class="n">exerciseCmd</span> <span class="n">iou</span> <span class="kt">Transfer</span> <span class="kr">with</span>
      <span class="n">newOwner</span> <span class="ow">=</span> <span class="n">bob</span>
</pre></div>
</div>
<p>Similarly, you can write a <code class="docutils literal notranslate"><span class="pre">Redeem</span></code> choice, which allows the <code class="docutils literal notranslate"><span class="pre">owner</span></code> to redeem an <code class="docutils literal notranslate"><span class="pre">Iou</span></code> during business hours on weekdays. The choice doesn’t do anything other than archiving the <code class="docutils literal notranslate"><span class="pre">SimpleIou</span></code>. (This assumes that actual cash changes hands off-ledger.)</p>
<div class="highlight-daml notranslate"><div class="highlight"><pre><span></span>    <span class="kr">controller</span> <span class="n">owner</span> <span class="kr">can</span>
      <span class="kt">Redeem</span>
        <span class="kt">:</span> <span class="nb">()</span>
        <span class="kr">do</span>
          <span class="n">now</span> <span class="ow">&lt;-</span> <span class="n">getTime</span>
          <span class="kr">let</span>
            <span class="n">today</span> <span class="ow">=</span> <span class="n">toDateUTC</span> <span class="n">now</span>
            <span class="n">dow</span> <span class="ow">=</span> <span class="n">dayOfWeek</span> <span class="n">today</span>
            <span class="n">timeofday</span> <span class="ow">=</span> <span class="n">now</span> <span class="p">`</span><span class="n">subTime</span><span class="p">`</span> <span class="n">time</span> <span class="n">today</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span>
            <span class="n">hrs</span> <span class="ow">=</span> <span class="n">convertRelTimeToMicroseconds</span> <span class="n">timeofday</span> <span class="o">/</span> <span class="mi">3600000000</span>
          <span class="n">assertMsg</span>
            <span class="p">(</span><span class="s">&quot;Cannot redeem outside business hours. Current time: &quot;</span> <span class="o">&lt;&gt;</span> <span class="n">show</span> <span class="n">timeofday</span><span class="p">)</span>
            <span class="p">(</span><span class="n">hrs</span> <span class="o">&gt;=</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">hrs</span> <span class="o">&lt;=</span> <span class="mi">18</span><span class="p">)</span>
          <span class="kr">case</span> <span class="n">dow</span> <span class="kr">of</span>
            <span class="kt">Saturday</span> <span class="ow">-&gt;</span> <span class="n">abort</span> <span class="s">&quot;Cannot redeem on a Saturday.&quot;</span>
            <span class="kt">Sunday</span> <span class="ow">-&gt;</span> <span class="n">abort</span> <span class="s">&quot;Cannot redeem on a Sunday.&quot;</span>
            <span class="kr">_</span> <span class="ow">-&gt;</span> <span class="kr">return</span> <span class="nb">()</span>
</pre></div>
</div>
<div class="highlight-daml notranslate"><div class="highlight"><pre><span></span>  <span class="c1">-- June 1st 2019 is a Saturday.</span>
  <span class="n">setTime</span> <span class="p">(</span><span class="n">time</span> <span class="p">(</span><span class="n">date</span> <span class="mi">2019</span> <span class="kt">Jun</span> <span class="mi">1</span><span class="p">)</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">)</span>
  <span class="c1">-- Bob cannot redeem on a Saturday.</span>
  <span class="n">submitMustFail</span> <span class="n">bob</span> <span class="kr">do</span>
    <span class="n">exerciseCmd</span> <span class="n">iou2</span> <span class="kt">Redeem</span>

  <span class="c1">-- Not even at mid-day.</span>
  <span class="n">passTime</span> <span class="p">(</span><span class="n">hours</span> <span class="mi">12</span><span class="p">)</span>
  <span class="c1">-- Bob cannot redeem on a Saturday.</span>
  <span class="n">submitMustFail</span> <span class="n">bob</span> <span class="kr">do</span>
    <span class="n">exerciseCmd</span> <span class="n">iou2</span> <span class="kt">Redeem</span>

  <span class="c1">-- Bob also cannot redeem at 6am on a Monday.</span>
  <span class="n">passTime</span> <span class="p">(</span><span class="n">hours</span> <span class="mi">42</span><span class="p">)</span>
  <span class="n">submitMustFail</span> <span class="n">bob</span> <span class="kr">do</span>
    <span class="n">exerciseCmd</span> <span class="n">iou2</span> <span class="kt">Redeem</span>

  <span class="c1">-- Bob can redeem at 8am on Monday.</span>
  <span class="n">passTime</span> <span class="p">(</span><span class="n">hours</span> <span class="mi">2</span><span class="p">)</span>
  <span class="n">submit</span> <span class="n">bob</span> <span class="kr">do</span>
    <span class="n">exerciseCmd</span> <span class="n">iou2</span> <span class="kt">Redeem</span>
</pre></div>
</div>
<p>There are quite a few new time-related functions from the <code class="docutils literal notranslate"><span class="pre">DA.Time</span></code> and <code class="docutils literal notranslate"><span class="pre">DA.Date</span></code> libraries here. Their names should be reasonably descriptive so how they work won’t be covered here, but given that Daml assumes it is run in a distributed setting, we will still discuss time in Daml.</p>
<p>There’s also quite a lot going on inside the <code class="docutils literal notranslate"><span class="pre">do</span></code> block of the <code class="docutils literal notranslate"><span class="pre">Redeem</span></code> choice, with several uses of the <code class="docutils literal notranslate"><span class="pre">&lt;-</span></code> operator. <code class="docutils literal notranslate"><span class="pre">do</span></code> blocks and <code class="docutils literal notranslate"><span class="pre">&lt;-</span></code> deserve a proper explanation at this point.</p>
</div>
<div class="section" id="time-on-daml-ledgers">
<h2>Time on Daml ledgers<a class="headerlink" href="#time-on-daml-ledgers" title="Permalink to this headline">¶</a></h2>
<p>Each transaction on a Daml ledger has two timestamps called the <em>ledger time (LT)</em> and the <em>record time (RT)</em>. The ledger time is set by the participant, the record time is set by the ledger.</p>
<p>Each Daml ledger has a policy on the allowed difference between LT and RT called the <em>skew</em>. The participant has to take a good guess at what the record time will be. If it’s too far off, the transaction will be rejected.</p>
<p><code class="docutils literal notranslate"><span class="pre">getTime</span></code> is an action that gets the LT from the ledger. In the above example, that time is taken apart into day of week and hour of day using standard library functions from <code class="docutils literal notranslate"><span class="pre">DA.Date</span></code> and <code class="docutils literal notranslate"><span class="pre">DA.Time</span></code>. The hour of the day is checked to be in the range from 8 to 18.</p>
<p>Consider the following example: Suppose that the ledger had a skew of 10 seconds. At 17:59:55, Alice submits a transaction to redeem an Iou. One second later, the transaction is assigned a LT of 17:59:56, but then takes 10 seconds to commit and is recorded on the ledger at 18:00:06. Even though it was committed after business hours, it would be a valid transaction and be committed successfully as <code class="docutils literal notranslate"><span class="pre">getTime</span></code> will return 17:59:56 so <code class="docutils literal notranslate"><span class="pre">hrs</span> <span class="pre">==</span> <span class="pre">17</span></code>. Since the RT is 18:00:06, <code class="docutils literal notranslate"><span class="pre">LT</span> <span class="pre">-</span> <span class="pre">RT</span> <span class="pre">&lt;=</span> <span class="pre">10</span> <span class="pre">seconds</span></code> and the transaction won’t be rejected.</p>
<p>Time therefore has to be considered slightly fuzzy in Daml, with the fuzziness depending on the skew parameter.</p>
<p>For details, see <a class="reference internal" href="../../concepts/time.html#time"><span class="std std-ref">Background concepts - time</span></a>.</p>
<div class="section" id="time-in-test-scripts">
<h3>Time in test scripts<a class="headerlink" href="#time-in-test-scripts" title="Permalink to this headline">¶</a></h3>
<p>For tests, you can set time using the following functions:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">setTime</span></code>, which sets the ledger time to the given time.</li>
<li><code class="docutils literal notranslate"><span class="pre">passTime</span></code>, which takes a <code class="docutils literal notranslate"><span class="pre">RelTime</span></code> (a relative time) and moves the ledger by that much.</li>
</ul>
</div>
<div class="section" id="time-on-ledgers">
<h3>Time on ledgers<a class="headerlink" href="#time-on-ledgers" title="Permalink to this headline">¶</a></h3>
<p>On a distributed Daml ledger, there are no guarantees that ledger time or record time are strictly increasing. The only guarantee is that ledger time is increasing with causality. That is, if a transaction <code class="docutils literal notranslate"><span class="pre">TX2</span></code> depends on a transaction <code class="docutils literal notranslate"><span class="pre">TX1</span></code>, then the ledger enforces that the LT of <code class="docutils literal notranslate"><span class="pre">TX2</span></code> is greater than or equal to that of <code class="docutils literal notranslate"><span class="pre">TX1</span></code>:</p>
<div class="highlight-daml notranslate"><div class="highlight"><pre><span></span>  <span class="n">iou3</span> <span class="ow">&lt;-</span> <span class="n">submit</span> <span class="n">dora</span> <span class="kr">do</span>
    <span class="n">createCmd</span> <span class="kt">SimpleIou</span> <span class="kr">with</span>
      <span class="n">issuer</span> <span class="ow">=</span> <span class="n">dora</span>
      <span class="n">owner</span> <span class="ow">=</span> <span class="n">alice</span>
      <span class="n">cash</span> <span class="ow">=</span> <span class="kt">Cash</span> <span class="kr">with</span>
        <span class="n">amount</span> <span class="ow">=</span> <span class="mf">100.0</span>
        <span class="n">currency</span> <span class="ow">=</span> <span class="s">&quot;USD&quot;</span>

  <span class="n">passTime</span> <span class="p">(</span><span class="n">days</span> <span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">))</span>
  <span class="n">submitMustFail</span> <span class="n">alice</span> <span class="kr">do</span>
    <span class="n">exerciseCmd</span> <span class="n">iou3</span> <span class="kt">Redeem</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="actions-and-do-blocks">
<h2>Actions and <code class="docutils literal notranslate"><span class="pre">do</span></code> blocks<a class="headerlink" href="#actions-and-do-blocks" title="Permalink to this headline">¶</a></h2>
<p>You have come across <code class="docutils literal notranslate"><span class="pre">do</span></code> blocks and <code class="docutils literal notranslate"><span class="pre">&lt;-</span></code> notations in two contexts by now: <code class="docutils literal notranslate"><span class="pre">Script</span></code> and <code class="docutils literal notranslate"><span class="pre">Update</span></code>. Both of these are examples of an <code class="docutils literal notranslate"><span class="pre">Action</span></code>, also called a <em>Monad</em> in functional programming. You can construct <code class="docutils literal notranslate"><span class="pre">Actions</span></code> conveniently using <code class="docutils literal notranslate"><span class="pre">do</span></code> notation.</p>
<p>Understanding <code class="docutils literal notranslate"><span class="pre">Actions</span></code> and <code class="docutils literal notranslate"><span class="pre">do</span></code> blocks is therefore crucial to being able to construct correct contract models and test them, so this section will explain them in some detail.</p>
<div class="section" id="pure-expressions-compared-to-actions">
<h3>Pure expressions compared to Actions<a class="headerlink" href="#pure-expressions-compared-to-actions" title="Permalink to this headline">¶</a></h3>
<p>Expressions in Daml are pure in the sense that they have no side-effects: they neither read nor modify any external state. If you know the value of all variables in scope and write an expression, you can work out the value of that expression on pen and paper.</p>
<p>However, the expressions you’ve seen that used the <code class="docutils literal notranslate"><span class="pre">&lt;-</span></code> notation are not like that. For example, take <code class="docutils literal notranslate"><span class="pre">getTime</span></code>, which is an <code class="docutils literal notranslate"><span class="pre">Action</span></code>. Here’s the example we used earlier:</p>
<div class="highlight-daml notranslate"><div class="highlight"><pre><span></span><span class="nf">now</span> <span class="ow">&lt;-</span> <span class="n">getTime</span>
</pre></div>
</div>
<p>You cannot work out the value of <code class="docutils literal notranslate"><span class="pre">now</span></code> based on any variable in scope. To put it another way, there is no expression <code class="docutils literal notranslate"><span class="pre">expr</span></code> that you could put on the right hand side of <code class="docutils literal notranslate"><span class="pre">now</span> <span class="pre">=</span> <span class="pre">expr</span></code>. To get the ledger time, you must be in the context of a submitted transaction, and then look at that context.</p>
<p>Similarly, you’ve come across <code class="docutils literal notranslate"><span class="pre">fetch</span></code>. If you have <code class="docutils literal notranslate"><span class="pre">cid</span> <span class="pre">:</span> <span class="pre">ContractId</span> <span class="pre">Account</span></code> in scope and you come across the expression <code class="docutils literal notranslate"><span class="pre">fetch</span> <span class="pre">cid</span></code>, you can’t evaluate that to an <code class="docutils literal notranslate"><span class="pre">Account</span></code> so you can’t write <code class="docutils literal notranslate"><span class="pre">account</span> <span class="pre">=</span> <span class="pre">fetch</span> <span class="pre">cid</span></code>. To do so, you’d have to have a ledger you can look that contract ID up on.</p>
</div>
<div class="section" id="actions-and-impurity">
<h3>Actions and impurity<a class="headerlink" href="#actions-and-impurity" title="Permalink to this headline">¶</a></h3>
<p>Actions are a way to handle such “impure” expressions. <code class="docutils literal notranslate"><span class="pre">Action</span> <span class="pre">a</span></code> is a type class with a single parameter <code class="docutils literal notranslate"><span class="pre">a</span></code>, and <code class="docutils literal notranslate"><span class="pre">Update</span></code> and <code class="docutils literal notranslate"><span class="pre">Script</span></code> are instances of <code class="docutils literal notranslate"><span class="pre">Action</span></code>. A value of such a type <code class="docutils literal notranslate"><span class="pre">m</span> <span class="pre">a</span></code> where <code class="docutils literal notranslate"><span class="pre">m</span></code> is an instance of <code class="docutils literal notranslate"><span class="pre">Action</span></code> can be interpreted as “a recipe for an action of type <code class="docutils literal notranslate"><span class="pre">m</span></code>, which, when executed, returns a value <code class="docutils literal notranslate"><span class="pre">a</span></code>”.</p>
<p>You can always write a recipe using just pen and paper, but you can’t cook it up unless you are in the context of a kitchen with the right ingredients and utensils. When cooking the recipe you have an effect – you change the state of the kitchen – and a return value – the thing you leave the kitchen with.</p>
<ul class="simple">
<li>An <code class="docutils literal notranslate"><span class="pre">Update</span> <span class="pre">a</span></code> is “a recipe to update a Daml ledger, which, when committed, has the effect of changing the ledger, and returns a value of type <code class="docutils literal notranslate"><span class="pre">a</span></code>”. An update to a Daml ledger is a transaction so equivalently, an <code class="docutils literal notranslate"><span class="pre">Update</span> <span class="pre">a</span></code> is “a recipe to construct a transaction, which, when executed in the context of a ledger, returns a value of type <code class="docutils literal notranslate"><span class="pre">a</span></code>”.</li>
<li>A <code class="docutils literal notranslate"><span class="pre">Script</span> <span class="pre">a</span></code> is “a recipe for a test, which, when performed against a ledger, has the effect of changing the ledger in ways analogous to those available via the API, and returns a value of type <code class="docutils literal notranslate"><span class="pre">a</span></code>”.</li>
</ul>
<p>Expressions like <code class="docutils literal notranslate"><span class="pre">getTime</span></code>, <code class="docutils literal notranslate"><span class="pre">allocateParty</span> <span class="pre">party</span></code>, <code class="docutils literal notranslate"><span class="pre">passTime</span> <span class="pre">time</span></code>, <code class="docutils literal notranslate"><span class="pre">submit</span> <span class="pre">party</span> <span class="pre">commands</span></code>, <code class="docutils literal notranslate"><span class="pre">create</span> <span class="pre">contract</span></code> and <code class="docutils literal notranslate"><span class="pre">exercise</span> <span class="pre">choice</span></code> should make more sense in that light. For example:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">getTime</span> <span class="pre">:</span> <span class="pre">Update</span> <span class="pre">Time</span></code> is the recipe for an empty transaction that also happens to return a value of type <code class="docutils literal notranslate"><span class="pre">Time</span></code>.</li>
<li><code class="docutils literal notranslate"><span class="pre">passTime</span> <span class="pre">(days</span> <span class="pre">10)</span> <span class="pre">:</span> <span class="pre">Script</span> <span class="pre">()</span></code> is a recipe for a transaction that doesn’t submit any transactions, but has the side-effect of changing the LT of the test ledger. It returns <code class="docutils literal notranslate"><span class="pre">()</span></code>, also called <code class="docutils literal notranslate"><span class="pre">Unit</span></code> and can be thought of as a zero-tuple.</li>
<li><code class="docutils literal notranslate"><span class="pre">create</span> <span class="pre">iou</span> <span class="pre">:</span> <span class="pre">Update</span> <span class="pre">(ContractId</span> <span class="pre">Iou)</span></code>, where <code class="docutils literal notranslate"><span class="pre">iou</span> <span class="pre">:</span> <span class="pre">Iou</span></code> is a recipe for a transaction consisting of a single <code class="docutils literal notranslate"><span class="pre">create</span></code> action, and returns the contract id of the created contract if successful.</li>
<li><code class="docutils literal notranslate"><span class="pre">submit</span> <span class="pre">alice</span> <span class="pre">(createCmd</span> <span class="pre">iou)</span> <span class="pre">:</span> <span class="pre">Script</span> <span class="pre">(ContractId</span> <span class="pre">Iou)</span></code> is a recipe for a script in which Alice sends the command <code class="docutils literal notranslate"><span class="pre">createCmd</span> <span class="pre">iou</span></code> to the ledger which produces a transaction and a return value of type <code class="docutils literal notranslate"><span class="pre">ContractId</span> <span class="pre">Iou</span></code> and returns that back to Alice.</li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">Commands</span></code> is a bit more restricted than
<code class="docutils literal notranslate"><span class="pre">Script</span></code> and <code class="docutils literal notranslate"><span class="pre">Update</span></code> as it represents a list of independent
commands sent to the ledger. You can still use <code class="docutils literal notranslate"><span class="pre">do</span></code> blocks but if
you have more than one command in a single <code class="docutils literal notranslate"><span class="pre">do</span></code> block you need to
enable the <code class="docutils literal notranslate"><span class="pre">ApplicativeDo</span></code> extension at the beginning of your file.
In addition to that, the last statement in such a <code class="docutils literal notranslate"><span class="pre">do</span></code> block must be of the form
<code class="docutils literal notranslate"><span class="pre">return</span> <span class="pre">expr</span></code> or <code class="docutils literal notranslate"><span class="pre">pure</span> <span class="pre">expr</span></code>.
<code class="docutils literal notranslate"><span class="pre">Applicative</span></code> is
a more restricted version of <code class="docutils literal notranslate"><span class="pre">Action</span></code> that enforces that there are
no dependencies between commands. If you do have dependencies between
commands, you can always wrap it in a choice in a helper template and
call that via <code class="docutils literal notranslate"><span class="pre">createAndExerciseCmd</span></code> just like we did to call
<code class="docutils literal notranslate"><span class="pre">fetchByKey</span></code>. Alternatively, if you do not need them to be part of the
same transaction, you can make multiple calls to <code class="docutils literal notranslate"><span class="pre">submit</span></code>.</p>
<div class="highlight-daml notranslate"><div class="highlight"><pre><span></span><span class="cm">{-# LANGUAGE ApplicativeDo #-}</span>
<span class="kr">module</span> <span class="nn">Restrictions</span> <span class="kr">where</span>
</pre></div>
</div>
</div>
<div class="section" id="chaining-up-actions-with-do-blocks">
<h3>Chaining up actions with do blocks<a class="headerlink" href="#chaining-up-actions-with-do-blocks" title="Permalink to this headline">¶</a></h3>
<p>An action followed by another action, possibly depending on the result of the first action, is just another action. Specifically:</p>
<ul class="simple">
<li>A transaction is a list of actions. So a transaction followed by another transaction is again a transaction.</li>
<li>A script is a list of interactions with the ledger (<code class="docutils literal notranslate"><span class="pre">submit</span></code>, <code class="docutils literal notranslate"><span class="pre">allocateParty</span></code>, <code class="docutils literal notranslate"><span class="pre">passTime</span></code>, etc). So a script followed by another script is again a script.</li>
</ul>
<p>This is where <code class="docutils literal notranslate"><span class="pre">do</span></code> blocks come in. <code class="docutils literal notranslate"><span class="pre">do</span></code> blocks allow you to build complex actions from simple ones, using the results of earlier actions in later ones.</p>
<div class="highlight-daml notranslate"><div class="highlight"><pre><span></span><span class="nf">sub_script1</span> <span class="p">(</span><span class="n">alice</span><span class="p">,</span> <span class="n">dora</span><span class="p">)</span> <span class="ow">=</span> <span class="kr">do</span>
  <span class="n">submit</span> <span class="n">dora</span> <span class="kr">do</span>
    <span class="n">createCmd</span> <span class="kt">SimpleIou</span> <span class="kr">with</span>
      <span class="n">issuer</span> <span class="ow">=</span> <span class="n">dora</span>
      <span class="n">owner</span> <span class="ow">=</span> <span class="n">alice</span>
      <span class="n">cash</span> <span class="ow">=</span> <span class="kt">Cash</span> <span class="kr">with</span>
        <span class="n">amount</span> <span class="ow">=</span> <span class="mf">100.0</span>
        <span class="n">currency</span> <span class="ow">=</span> <span class="s">&quot;USD&quot;</span>

<span class="nf">sub_script2</span> <span class="ow">=</span> <span class="kr">do</span>
  <span class="n">passTime</span> <span class="p">(</span><span class="n">days</span> <span class="mi">1</span><span class="p">)</span>
  <span class="n">passTime</span> <span class="p">(</span><span class="n">days</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
  <span class="kr">return</span> <span class="mi">42</span>

<span class="nf">sub_script3</span> <span class="p">(</span><span class="n">bob</span><span class="p">,</span> <span class="n">dora</span><span class="p">)</span> <span class="ow">=</span> <span class="kr">do</span>
  <span class="n">submit</span> <span class="n">dora</span> <span class="kr">do</span>
    <span class="n">createCmd</span> <span class="kt">SimpleIou</span> <span class="kr">with</span>
      <span class="n">issuer</span> <span class="ow">=</span> <span class="n">dora</span>
      <span class="n">owner</span> <span class="ow">=</span> <span class="n">bob</span>
      <span class="n">cash</span> <span class="ow">=</span> <span class="kt">Cash</span> <span class="kr">with</span>
        <span class="n">amount</span> <span class="ow">=</span> <span class="mf">100.0</span>
        <span class="n">currency</span> <span class="ow">=</span> <span class="s">&quot;USD&quot;</span>

<span class="nf">main_</span><span class="kt">:</span> <span class="kt">Script</span> <span class="nb">()</span> <span class="ow">=</span> <span class="kr">do</span>
  <span class="n">dora</span> <span class="ow">&lt;-</span> <span class="n">allocateParty</span> <span class="s">&quot;Dora&quot;</span>
  <span class="n">alice</span> <span class="ow">&lt;-</span> <span class="n">allocateParty</span> <span class="s">&quot;Alice&quot;</span>
  <span class="n">bob</span> <span class="ow">&lt;-</span> <span class="n">allocateParty</span> <span class="s">&quot;Bob&quot;</span>

  <span class="n">iou1</span> <span class="ow">&lt;-</span> <span class="n">sub_script1</span> <span class="p">(</span><span class="n">alice</span><span class="p">,</span> <span class="n">dora</span><span class="p">)</span>
  <span class="n">sub_script2</span>
  <span class="n">iou2</span> <span class="ow">&lt;-</span> <span class="n">sub_script3</span> <span class="p">(</span><span class="n">bob</span><span class="p">,</span> <span class="n">dora</span><span class="p">)</span>

  <span class="n">submit</span> <span class="n">dora</span> <span class="kr">do</span>
    <span class="n">archiveCmd</span> <span class="n">iou1</span>
    <span class="n">archiveCmd</span> <span class="n">iou2</span>
    <span class="n">pure</span> <span class="nb">()</span>
</pre></div>
</div>
<p>Above, we see <code class="docutils literal notranslate"><span class="pre">do</span></code> blocks in action for both <code class="docutils literal notranslate"><span class="pre">Script</span></code> and <code class="docutils literal notranslate"><span class="pre">Update</span></code>.</p>
</div>
<div class="section" id="wrapping-values-in-actions">
<h3>Wrapping values in actions<a class="headerlink" href="#wrapping-values-in-actions" title="Permalink to this headline">¶</a></h3>
<p>You may already have noticed the use of <code class="docutils literal notranslate"><span class="pre">return</span></code> in the redeem choice. <code class="docutils literal notranslate"><span class="pre">return</span> <span class="pre">x</span></code> is a no-op action which returns value <code class="docutils literal notranslate"><span class="pre">x</span></code> so <code class="docutils literal notranslate"><span class="pre">return</span> <span class="pre">42</span> <span class="pre">:</span> <span class="pre">Update</span> <span class="pre">Int</span></code>. Since <code class="docutils literal notranslate"><span class="pre">do</span></code> blocks always return the value of their last action, <code class="docutils literal notranslate"><span class="pre">sub_script2</span> <span class="pre">:</span> <span class="pre">Script</span> <span class="pre">Int</span></code>.</p>
</div>
</div>
<div class="section" id="failing-actions">
<h2>Failing actions<a class="headerlink" href="#failing-actions" title="Permalink to this headline">¶</a></h2>
<p>Not only are <code class="docutils literal notranslate"><span class="pre">Update</span></code> and <code class="docutils literal notranslate"><span class="pre">Script</span></code> examples of <code class="docutils literal notranslate"><span class="pre">Action</span></code>, they are both examples of actions that can fail, e.g. because a transaction is illegal or the party retrieved via <code class="docutils literal notranslate"><span class="pre">allocateParty</span></code> doesn’t exist on the ledger.</p>
<p>Each has a special action <code class="docutils literal notranslate"><span class="pre">abort</span> <span class="pre">txt</span></code> that represents failure, and that takes on type <code class="docutils literal notranslate"><span class="pre">Update</span> <span class="pre">()</span></code> or <code class="docutils literal notranslate"><span class="pre">Script</span> <span class="pre">()</span></code> depending on context .</p>
<p>Transactions succeed or fail <em>atomically</em> as a whole. Scripts on the other hand do not fail atomically: while each <code class="docutils literal notranslate"><span class="pre">submit</span></code> is atomic, if a <code class="docutils literal notranslate"><span class="pre">submit</span></code> succeeded and the script fails later, the effects of that <code class="docutils literal notranslate"><span class="pre">submit</span></code> will still be applied to the ledger.</p>
<p>The last expression in the <code class="docutils literal notranslate"><span class="pre">do</span></code> block of the <code class="docutils literal notranslate"><span class="pre">Redeem</span></code> choice is a pattern matching expression on <code class="docutils literal notranslate"><span class="pre">dow</span></code>. It has type <code class="docutils literal notranslate"><span class="pre">Update</span> <span class="pre">()</span></code> and is either an <code class="docutils literal notranslate"><span class="pre">abort</span></code> or <code class="docutils literal notranslate"><span class="pre">return</span></code> depending on the day of week. So during the week, it’s a no-op and on weekends, it’s the special failure action. Thanks to the atomicity of transactions, no transaction can ever make use of the <code class="docutils literal notranslate"><span class="pre">Redeem</span></code> choice on weekends, because it fails the entire transaction.</p>
</div>
<div class="section" id="a-sample-action">
<h2>A sample Action<a class="headerlink" href="#a-sample-action" title="Permalink to this headline">¶</a></h2>
<p>If the above didn’t make complete sense, here’s another example to explain what actions are more generally, by creating a new type that is also an action. <code class="docutils literal notranslate"><span class="pre">CoinGame</span> <span class="pre">a</span></code> is an <code class="docutils literal notranslate"><span class="pre">Action</span> <span class="pre">a</span></code> in which a <code class="docutils literal notranslate"><span class="pre">Coin</span></code> is flipped. The <code class="docutils literal notranslate"><span class="pre">Coin</span></code> is a pseudo-random number generator and each flip has the effect of changing the random number generator’s state. Based on the <code class="docutils literal notranslate"><span class="pre">Heads</span></code> and <code class="docutils literal notranslate"><span class="pre">Tails</span></code> results, a return value of type <code class="docutils literal notranslate"><span class="pre">a</span></code> is calculated.</p>
<div class="highlight-daml notranslate"><div class="highlight"><pre><span></span><span class="kr">data</span> <span class="kt">Face</span> <span class="ow">=</span> <span class="kt">Heads</span> <span class="o">|</span> <span class="kt">Tails</span>
  <span class="kr">deriving</span> <span class="p">(</span><span class="kt">Eq</span><span class="p">,</span> <span class="kt">Show</span><span class="p">,</span> <span class="kt">Enum</span><span class="p">)</span>

<span class="kr">data</span> <span class="kt">CoinGame</span> <span class="n">a</span> <span class="ow">=</span> <span class="kt">CoinGame</span> <span class="kr">with</span>
  <span class="n">play</span> <span class="kt">:</span> <span class="kt">Coin</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="kt">Coin</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>

<span class="nf">flipCoin</span> <span class="kt">:</span> <span class="kt">CoinGame</span> <span class="kt">Face</span>
<span class="nf">getCoin</span> <span class="kt">:</span> <span class="kt">Script</span> <span class="kt">Coin</span>
</pre></div>
</div>
<p>A <code class="docutils literal notranslate"><span class="pre">CoinGame</span> <span class="pre">a</span></code> exposes a function <code class="docutils literal notranslate"><span class="pre">play</span></code> which takes a <code class="docutils literal notranslate"><span class="pre">Coin</span></code> and returns a new <code class="docutils literal notranslate"><span class="pre">Coin</span></code> and a result <code class="docutils literal notranslate"><span class="pre">a</span></code>. More on the <code class="docutils literal notranslate"><span class="pre">-&gt;</span></code> syntax for functions later.</p>
<p><code class="docutils literal notranslate"><span class="pre">Coin</span></code> and <code class="docutils literal notranslate"><span class="pre">play</span></code> are deliberately left obscure in the above. All you have is an action <code class="docutils literal notranslate"><span class="pre">getCoin</span></code> to get your hands on a <code class="docutils literal notranslate"><span class="pre">Coin</span></code> in a <code class="docutils literal notranslate"><span class="pre">Script</span></code> context and an action <code class="docutils literal notranslate"><span class="pre">flipCoin</span></code> which represents the simplest possible game: a single coin flip resulting in a  <code class="docutils literal notranslate"><span class="pre">Face</span></code>.</p>
<p>You can’t play any <code class="docutils literal notranslate"><span class="pre">CoinGame</span></code> game on pen and paper as you don’t have a coin, but you can write down a script or recipe for a game:</p>
<div class="highlight-daml notranslate"><div class="highlight"><pre><span></span><span class="nf">coin_test</span> <span class="ow">=</span> <span class="kr">do</span>
  <span class="c1">-- The coin is pseudo-random on LT so change the parameter to change the game.</span>
  <span class="n">setTime</span> <span class="p">(</span><span class="n">time</span> <span class="p">(</span><span class="n">date</span> <span class="mi">2019</span> <span class="kt">Jun</span> <span class="mi">1</span><span class="p">)</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">)</span>
  <span class="n">passTime</span> <span class="p">(</span><span class="n">seconds</span> <span class="mi">2</span><span class="p">)</span>
  <span class="n">coin</span> <span class="ow">&lt;-</span> <span class="n">getCoin</span>
  <span class="kr">let</span>
    <span class="n">game</span> <span class="ow">=</span> <span class="kr">do</span>
      <span class="n">f1r</span> <span class="ow">&lt;-</span> <span class="n">flipCoin</span>
      <span class="n">f2r</span> <span class="ow">&lt;-</span> <span class="n">flipCoin</span>
      <span class="n">f3r</span> <span class="ow">&lt;-</span> <span class="n">flipCoin</span>

      <span class="kr">if</span> <span class="n">all</span> <span class="p">(</span><span class="o">==</span> <span class="kt">Heads</span><span class="p">)</span> <span class="p">[</span><span class="n">f1r</span><span class="p">,</span> <span class="n">f2r</span><span class="p">,</span> <span class="n">f3r</span><span class="p">]</span>
        <span class="kr">then</span> <span class="kr">return</span> <span class="s">&quot;Win&quot;</span>
        <span class="kr">else</span> <span class="kr">return</span> <span class="s">&quot;Loss&quot;</span>
    <span class="p">(</span><span class="n">newCoin</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span> <span class="ow">=</span> <span class="n">game</span><span class="o">.</span><span class="n">play</span> <span class="n">coin</span>

  <span class="n">assert</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="s">&quot;Win&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">game</span></code> expression is a <code class="docutils literal notranslate"><span class="pre">CoinGame</span></code> in which a coin is flipped three times. If all three tosses return <code class="docutils literal notranslate"><span class="pre">Heads</span></code>, the result is <code class="docutils literal notranslate"><span class="pre">&quot;Win&quot;</span></code>, or else <code class="docutils literal notranslate"><span class="pre">&quot;Loss&quot;</span></code>.</p>
<p>In a <code class="docutils literal notranslate"><span class="pre">Script</span></code> context you can get a <code class="docutils literal notranslate"><span class="pre">Coin</span></code> using the <code class="docutils literal notranslate"><span class="pre">getCoin</span></code> action, which uses the LT to calculate a seed, and play the game.</p>
<p><em>Somehow</em> the <code class="docutils literal notranslate"><span class="pre">Coin</span></code> is threaded through the various actions. If you want to look through the looking glass and understand in-depth what’s going on, you can look at the source file to see how the <code class="docutils literal notranslate"><span class="pre">CoinGame</span></code> action is implemented, though be warned that the implementation uses a lot of Daml features we haven’t introduced yet in this introduction.</p>
<p>More generally, if you want to learn more about Actions (aka Monads), we recommend a general course on functional programming, and Haskell in particular. See <a class="reference internal" href="10_Functional101.html#haskell-connection"><span class="std std-ref">The Haskell Connection</span></a> for some suggestions.</p>
</div>
<div class="section" id="errors">
<h2>Errors<a class="headerlink" href="#errors" title="Permalink to this headline">¶</a></h2>
<p>Above, you’ve learnt about <code class="docutils literal notranslate"><span class="pre">assertMsg</span></code> and <code class="docutils literal notranslate"><span class="pre">abort</span></code>, which represent (potentially) failing actions. Actions only have an effect when they are performed, so the following script succeeds or fails depending on the value of <code class="docutils literal notranslate"><span class="pre">abortScript</span></code>:</p>
<div class="highlight-daml notranslate"><div class="highlight"><pre><span></span><span class="nf">nonPerformedAbort</span> <span class="ow">=</span> <span class="kr">do</span>
  <span class="kr">let</span> <span class="n">abortScript</span> <span class="ow">=</span> <span class="kc">False</span>
  <span class="kr">let</span> <span class="n">failingAction</span> <span class="kt">:</span> <span class="kt">Script</span> <span class="nb">()</span> <span class="ow">=</span> <span class="n">abort</span> <span class="s">&quot;Foo&quot;</span>
  <span class="kr">let</span> <span class="n">successfulAction</span> <span class="kt">:</span> <span class="kt">Script</span> <span class="nb">()</span> <span class="ow">=</span> <span class="kr">return</span> <span class="nb">()</span>
  <span class="kr">if</span> <span class="n">abortScript</span> <span class="kr">then</span> <span class="n">failingAction</span> <span class="kr">else</span> <span class="n">successfulAction</span>
</pre></div>
</div>
<p>However, what about errors in contexts other than actions? Suppose we wanted to implement a function <code class="docutils literal notranslate"><span class="pre">pow</span></code> that takes an integer to the power of another positive integer. How do we handle that the second parameter has to be positive?</p>
<p>One option is to make the function explicitly partial by returning an <code class="docutils literal notranslate"><span class="pre">Optional</span></code>:</p>
<div class="highlight-daml notranslate"><div class="highlight"><pre><span></span><span class="nf">optPow</span> <span class="kt">:</span> <span class="kt">Int</span> <span class="ow">-&gt;</span> <span class="kt">Int</span> <span class="ow">-&gt;</span> <span class="kt">Optional</span> <span class="kt">Int</span>
<span class="nf">optPow</span> <span class="n">base</span> <span class="n">exponent</span>
 <span class="o">|</span> <span class="n">exponent</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">=</span> <span class="kt">Some</span> <span class="mi">1</span>
 <span class="o">|</span> <span class="n">exponent</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">=</span>
   <span class="kr">let</span> <span class="kt">Some</span> <span class="n">result</span> <span class="ow">=</span> <span class="n">optPow</span> <span class="n">base</span> <span class="p">(</span><span class="n">exponent</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
   <span class="kr">in</span> <span class="kt">Some</span> <span class="p">(</span><span class="n">base</span> <span class="o">*</span> <span class="n">result</span><span class="p">)</span>
 <span class="o">|</span> <span class="n">otherwise</span> <span class="ow">=</span> <span class="kt">None</span>
</pre></div>
</div>
<p>This is a useful pattern if we need to be able to handle the error case, but it also forces us to always handle it as we need to extract the result from an <code class="docutils literal notranslate"><span class="pre">Optional</span></code>. We can see the impact on convenience in the definition of the above function.  In cases, like division by zero or the above function, it can therefore be preferable to fail catastrophically instead:</p>
<div class="highlight-daml notranslate"><div class="highlight"><pre><span></span><span class="nf">errPow</span> <span class="kt">:</span> <span class="kt">Int</span> <span class="ow">-&gt;</span> <span class="kt">Int</span> <span class="ow">-&gt;</span> <span class="kt">Int</span>
<span class="nf">errPow</span> <span class="n">base</span> <span class="n">exponent</span>
 <span class="o">|</span> <span class="n">exponent</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">=</span> <span class="mi">1</span>
 <span class="o">|</span> <span class="n">exponent</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">=</span> <span class="n">base</span> <span class="o">*</span> <span class="n">errPow</span> <span class="n">base</span> <span class="p">(</span><span class="n">exponent</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
 <span class="o">|</span> <span class="n">otherwise</span> <span class="ow">=</span> <span class="ne">error</span> <span class="s">&quot;Negative exponent not supported&quot;</span>
</pre></div>
</div>
<p>The big downside to this is that even unused errors cause failures. The following script will fail, because <code class="docutils literal notranslate"><span class="pre">failingComputation</span></code> is evaluated:</p>
<div class="highlight-daml notranslate"><div class="highlight"><pre><span></span><span class="nf">nonPerformedError</span> <span class="ow">=</span> <span class="n">script</span> <span class="kr">do</span>
  <span class="kr">let</span> <span class="n">causeError</span> <span class="ow">=</span> <span class="kc">False</span>
  <span class="kr">let</span> <span class="n">failingComputation</span> <span class="ow">=</span> <span class="n">errPow</span> <span class="mi">1</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
  <span class="kr">let</span> <span class="n">successfulComputation</span> <span class="ow">=</span> <span class="n">errPow</span> <span class="mi">1</span> <span class="mi">1</span>
  <span class="kr">return</span> <span class="kr">if</span> <span class="n">causeError</span> <span class="kr">then</span> <span class="n">failingComputation</span> <span class="kr">else</span> <span class="n">successfulComputation</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">error</span></code> should therefore only be used in cases where the error case is unlikely to be encountered, and where explicit partiality would unduly impact usability of the function.</p>
</div>
<div class="section" id="next-up">
<h2>Next up<a class="headerlink" href="#next-up" title="Permalink to this headline">¶</a></h2>
<p>You can now specify a precise data and data-transformation model for Daml ledgers. In <a class="reference internal" href="6_Parties.html"><span class="doc">6 Parties and authority</span></a>, you will learn how to properly involve multiple parties in contracts, how authority works in Daml, and how to build contract models with strong guarantees in contexts with mutually distrusting entities.</p>
</div>
</div>


              
            </div>
            
            
              <!-- Copyright (c) 2021 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved. -->
<!-- SPDX-License-Identifier: Apache-2.0 -->

<footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="4_Transformations.html" class="da-btn da-btn-label btn-prev" title="4 Transforming data using choices" accesskey="p" rel="prev">Previous</a>
      
      
        <a href="6_Parties.html" class="da-btn da-btn-label btn-next" title="6 Parties and authority" accesskey="n" rel="next">Next</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        Copyright (c) 2021 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved. Any unauthorized use, duplication or distribution is strictly prohibited. &#34;Digital Asset&#34; and &#34;Daml&#34; are Registered in the U.S. Patent and Trademark Office.

    </p>
  </div> 

</footer>
            
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Copyright (c) 2021 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved. -->
<!-- SPDX-License-Identifier: Apache-2.0 -->





  <script type="text/javascript">
    jQuery(function () {
      SphinxRtdTheme.Navigation.enable(true);
      });
  </script>


  
    
  
  <div id="inpageContent"></div>
  

</body>
</html>